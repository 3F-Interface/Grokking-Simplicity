# 신뢰할 수 없는 코드를 쓰면서 불변셩 지키기

## 레거시 코드와 불변성

- 기존 사용되던 레거시 코드에 새로운 코드를 추가하게 되면 카피-온-라이트 원칙을 지킬 수 없음
- **defensive copy**를 통해 해결 가능
  - 데이터가 바뀌는 것을 완벽히 막아주는 원칙

## 방어적 복사 규칙

1. 데이터가 안전한 코드에서 나갈 때 복사하기
  - 불변성 데이터를 위한 깊은 복사본을 만듦
  - 신뢰할 수 없는 코드로 복사본을 전달
2. 안전한 코드로 데이터가 들어올 때 복사하기
  - 변경될 수도 있는 데이터가 들어오면 바로 깊은 복사본을 만들어 안전한 코드로 전달
  - 복사본을 안전한 코드에서 사용

## 방어적 복사가 쓰이던 곳

1. 웹 API
2. 얼랭과 엘릭서

## 카피-온-라이트와 방어적 복사

### 카피-온-라이트

1. 통제할 수 있는 데이터를 바꿀 때 사용
2. 얕은 복사
3. 바꿀 데이터의 얕은 복사본을 만들어 변경 후 리턴

### 방어적 복사

1. 신뢰할 수 없는 코드와 데이터를 주고 받을 때 사용
2. 깊은 복사
3. 안전지대로 들어오고 나가는 데이터에 깊은 복사
